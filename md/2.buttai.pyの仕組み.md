# buttai.py ç‰©ä½“æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ã®ä»•çµ„ã¿

## ğŸ¯ æ¦‚è¦

`buttai.py`ã¯ã€YOLOv8ã‚’ä½¿ç”¨ã—ã¦ç”»åƒå†…ã®ç‰©ä½“ã‚’æ¤œå‡ºã—ã€æ¤œå‡ºã•ã‚ŒãŸç‰©ä½“ã«åŸºã¥ã„ã¦OpenAI APIã‹ã‚‰æ„Ÿæƒ…ã‚’å–å¾—ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
ç”»åƒå…¥åŠ› â†’ YOLOv8ç‰©ä½“æ¤œå‡º â†’ æœ€é«˜ä¿¡é ¼åº¦ç‰©ä½“é¸æŠ â†’ OpenAI API â†’ æ„Ÿæƒ…å‡ºåŠ›
```

## ğŸ”§ ä¸»è¦æ©Ÿèƒ½

### 1. YOLOv8ãƒ¢ãƒ‡ãƒ«ç®¡ç†

#### ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–
```python
def load_model(model_name='yolov8n', conf=0.3):
    """ultralytics YOLOv8 Nanoãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™"""
    global model, model_conf
    try:
        model_path = f"{model_name}.pt"
        
        # ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®å‡¦ç†
        if not os.path.exists(model_path):
            print(f"Model file {model_path} not found. Downloading...")
            model = YOLO(model_name)  # è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        else:
            model = YOLO(model_path)
        
        model_conf = conf
        model.overrides['verbose'] = False  # ãƒ­ã‚°ã‚’å‰Šæ¸›
        
        print("YOLO model loaded successfully")
        return True
    except Exception as e:
        print(f"Error loading YOLO model: {e}")
        return False
```

#### ç‰¹å¾´
- **YOLOv8 Nano**: è»½é‡ã§é«˜é€Ÿãªç‰©ä½“æ¤œå‡º
- **è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**: åˆå›å®Ÿè¡Œæ™‚ã«ãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‹•å–å¾—
- **ä¿¡é ¼åº¦è¨­å®š**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ0.3ã€èª¿æ•´å¯èƒ½
- **ãƒ­ã‚°æŠ‘åˆ¶**: ä¸è¦ãªå‡ºåŠ›ã‚’å‰Šæ¸›

### 2. æ„Ÿæƒ…å–å¾—ã‚·ã‚¹ãƒ†ãƒ 

#### OpenAI APIé€£æº
```python
@lru_cache(maxsize=256)
def get_emotion(label):
    """ç‰©ä½“ãƒ©ãƒ™ãƒ«ã‹ã‚‰æ„Ÿæƒ…ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆAPIå°‚ç”¨ç‰ˆï¼‰"""
    try:
        init_openai_client()
        if client is not None:
            prompt = f"ç‰©ä½“ '{label}' ã‚’è¦‹ãŸã¨ãã®æ„Ÿæƒ…ã‚’ä¸€èªã§æ—¥æœ¬èªã§ç­”ãˆã¦ãã ã•ã„ã€‚"
            
            # æ–°APIå½¢å¼ + GPT-3.5-turboä½¿ç”¨
            response = client.chat.completions.create(
                model='gpt-3.5-turbo',
                messages=[{'role':'user','content':prompt}],
                max_tokens=5,  # ãƒˆãƒ¼ã‚¯ãƒ³æ•°å‰Šæ¸›
                temperature=0.3,  # æ¸©åº¦ä¸‹ã’ã¦å®‰å®šæ€§å‘ä¸Š
                timeout=10  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
            )
            
            emotion = response.choices[0].message.content.strip().strip('ã€Œã€"')
            if emotion:
                return emotion
        
        # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã§ããªã„å ´åˆã¾ãŸã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã®å ´åˆ
        return 'api error'
                
    except Exception as e:
        print(f"OpenAI API error: {e}")
        return 'api error'
```

#### ç‰¹å¾´
- **LRUã‚­ãƒ£ãƒƒã‚·ãƒ¥**: åŒã˜ç‰©ä½“ã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆæœ€å¤§256ä»¶ï¼‰
- **APIå„ªå…ˆ**: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¾æ›¸ã‚’å‰Šé™¤ã€APIå°‚ç”¨
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: APIå¤±æ•—æ™‚ã¯ã€Œapi errorã€ã‚’è¿”ã™
- **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**: GPT-3.5-turboã€æœ€å¤§5ãƒˆãƒ¼ã‚¯ãƒ³

### 3. ãƒ¡ã‚¤ãƒ³å‡¦ç†ãƒ•ãƒ­ãƒ¼

#### ç‰©ä½“æ¤œå‡ºãƒ»æ„Ÿæƒ…åˆ†æ
```python
def process_buttai(image_path):
    """ç”»åƒãƒ‘ã‚¹ã‚’å—ã‘å–ã‚Šã€ç‰©ä½“æ¤œå‡ºã¨æ„Ÿæƒ…ãƒ©ãƒ™ãƒ«ã‚’è¿”ã™ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰"""
    # ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–
    if model is None:
        if not load_model():
            return 'api error', 'no_model'  # ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—æ™‚

    try:
        # 1) ç”»åƒèª­ã¿è¾¼ã¿ï¼†æœ€é©åŒ–
        img = cv2.imread(image_path)
        if img is None:
            return 'api error', 'invalid_image'
        
        # ã‚ˆã‚ŠåŠ¹ç‡çš„ãªãƒªã‚µã‚¤ã‚ºï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ä¿æŒï¼‰
        h, w = img.shape[:2]
        scale = min(320/w, 320/h)
        new_w, new_h = int(w*scale), int(h*scale)
        img_small = cv2.resize(img, (new_w, new_h), interpolation=cv2.INTER_AREA)

        # 2) YOLOv8 Nanoæ¨è«–ï¼ˆæœ€é©åŒ–è¨­å®šï¼‰
        results = model(
            img_small, 
            conf=model_conf,
            verbose=False,  # ãƒ­ã‚°æŠ‘åˆ¶
            save=False,     # ä¿å­˜ã—ãªã„
            show=False      # è¡¨ç¤ºã—ãªã„
        )
        
        r = results[0]
        boxes = r.boxes
        
        if boxes is None or len(boxes) == 0:
            return 'api error', 'no_object'

        # 3) æœ€ã‚‚ä¿¡é ¼åº¦ã®é«˜ã„ç‰©ä½“ã‚’é¸æŠ
        confs = boxes.conf.cpu().numpy()
        cls_ids = boxes.cls.cpu().numpy().astype(int)
        
        idx = confs.argmax()
        confidence = confs[idx]
        
        # ä¿¡é ¼åº¦ãƒã‚§ãƒƒã‚¯
        if confidence < 0.25:  # é–¾å€¤ã‚’å°‘ã—ä¸‹ã’ã¦æ¤œå‡ºç‡å‘ä¸Š
            return 'api error', 'low_confidence'
        
        label = r.names[cls_ids[idx]]
        emotion = get_emotion(label)
        
        return emotion, label
        
    except Exception as e:
        print(f"Object detection error: {e}")
        return 'api error', 'error'
```

## ğŸ”„ å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—

### 1. ç”»åƒå‰å‡¦ç†
1. **ç”»åƒèª­ã¿è¾¼ã¿**: OpenCVä½¿ç”¨
2. **ãƒªã‚µã‚¤ã‚º**: 320pxä»¥ä¸‹ã«æœ€é©åŒ–ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ä¿æŒï¼‰
3. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: ç”»åƒã®æœ‰åŠ¹æ€§ç¢ºèª

### 2. ç‰©ä½“æ¤œå‡º
1. **YOLOv8æ¨è«–**: æœ€é©åŒ–ã•ã‚ŒãŸè¨­å®šã§å®Ÿè¡Œ
2. **çµæœå–å¾—**: ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã€ä¿¡é ¼åº¦ã€ã‚¯ãƒ©ã‚¹ID
3. **ä¿¡é ¼åº¦ãƒ•ã‚£ãƒ«ã‚¿**: 0.25ä»¥ä¸Šã®ç‰©ä½“ã®ã¿æ¡ç”¨

### 3. æ„Ÿæƒ…åˆ†æ
1. **æœ€é«˜ä¿¡é ¼åº¦ç‰©ä½“é¸æŠ**: æœ€ã‚‚ç¢ºå®Ÿãªæ¤œå‡ºçµæœã‚’ä½¿ç”¨
2. **OpenAI APIå‘¼ã³å‡ºã—**: ç‰©ä½“åã‹ã‚‰æ„Ÿæƒ…ã‚’å–å¾—
3. **çµæœè¿”å´**: æ„Ÿæƒ…æ–‡å­—åˆ—ã¨ãƒ©ãƒ™ãƒ«å

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ç”»åƒå‡¦ç†æœ€é©åŒ–
- **ãƒªã‚µã‚¤ã‚º**: 320pxåˆ¶é™ã§ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å‰Šæ¸›
- **è£œé–“æ–¹æ³•**: INTER_AREAä½¿ç”¨ã§é«˜å“è³ªãƒªã‚µã‚¤ã‚º
- **ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ä¿æŒ**: æ­ªã¿ãªã—ã§å‡¦ç†

### ãƒ¢ãƒ‡ãƒ«æœ€é©åŒ–
- **YOLOv8 Nano**: æœ€è»½é‡ãƒ¢ãƒ‡ãƒ«é¸æŠ
- **ãƒãƒƒãƒã‚µã‚¤ã‚º**: å˜ä¸€ç”»åƒå‡¦ç†
- **ãƒ­ã‚°æŠ‘åˆ¶**: ä¸è¦ãªå‡ºåŠ›å‰Šé™¤

### APIæœ€é©åŒ–
- **LRUã‚­ãƒ£ãƒƒã‚·ãƒ¥**: é‡è¤‡å‘¼ã³å‡ºã—å‰Šæ¸›
- **ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™**: æœ€å¤§5ãƒˆãƒ¼ã‚¯ãƒ³ã§é«˜é€ŸåŒ–
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 10ç§’ã§å¿œç­”ä¿è¨¼

## ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã¨å¯¾å¿œ

| ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ | è¿”ã‚Šå€¤ | èª¬æ˜ |
|-------------|--------|------|
| ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å¤±æ•— | `('api error', 'no_model')` | YOLOv8ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã«å¤±æ•— |
| ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•— | `('api error', 'invalid_image')` | ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡åŠ¹ã¾ãŸã¯ç ´æ |
| ç‰©ä½“æœªæ¤œå‡º | `('api error', 'no_object')` | ä¿¡é ¼åº¦ã®é«˜ã„ç‰©ä½“ãŒè¦‹ã¤ã‹ã‚‰ãªã„ |
| ä¿¡é ¼åº¦ä¸è¶³ | `('api error', 'low_confidence')` | æ¤œå‡ºä¿¡é ¼åº¦ãŒ0.25æœªæº€ |
| API ã‚¨ãƒ©ãƒ¼ | `('api error', ç‰©ä½“å)` | OpenAI APIå‘¼ã³å‡ºã—ã«å¤±æ•— |
| ãã®ä»–ã®ä¾‹å¤– | `('api error', 'error')` | äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ |

### çµ±ä¸€ã‚¨ãƒ©ãƒ¼å½¢å¼
- ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã§ã€Œapi errorã€ã‚’æ„Ÿæƒ…ã¨ã—ã¦è¿”ã™
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ„Ÿæƒ…ã¯å®Œå…¨ã«å‰Šé™¤
- ã‚¨ãƒ©ãƒ¼è©³ç´°ã¯ç¬¬äºŒæˆ»ã‚Šå€¤ã§æä¾›

## ğŸ”§ è¨­å®šé …ç›®

### ç’°å¢ƒå¤‰æ•°
```bash
OPENAI_API_KEY=your_openai_api_key  # å¿…é ˆ
```

### ãƒ¢ãƒ‡ãƒ«è¨­å®š
```python
model_name = 'yolov8n'  # YOLOv8 Nano
conf = 0.3              # ä¿¡é ¼åº¦é–¾å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
min_conf = 0.25         # æœ€å°ä¿¡é ¼åº¦é–¾å€¤
```

### APIè¨­å®š
```python
model = 'gpt-3.5-turbo'  # OpenAI ãƒ¢ãƒ‡ãƒ«
max_tokens = 5           # æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
temperature = 0.3        # æ¸©åº¦è¨­å®š
timeout = 10             # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰
```

## ğŸ“Š æ¤œå‡ºå¯èƒ½ãªç‰©ä½“

YOLOv8ã¯80ç¨®é¡ã®ç‰©ä½“ã‚’æ¤œå‡ºå¯èƒ½ï¼š

### äººãƒ»å‹•ç‰©
- person, dog, cat, bird, horse, sheep, cow, elephant, bear, zebra, giraffe

### ä¹—ã‚Šç‰©
- car, truck, bus, train, boat, airplane, bicycle, motorcycle

### å®¶å…·ãƒ»é›»åŒ–è£½å“
- chair, table, bed, toilet, tv, laptop, mouse, keyboard, cell phone

### é£Ÿã¹ç‰©
- banana, apple, sandwich, orange, broccoli, carrot, pizza, donut, cake

### ã‚¹ãƒãƒ¼ãƒ„ç”¨å“
- frisbee, skis, snowboard, sports ball, kite, baseball bat, tennis racket

### ãã®ä»–å¤šæ•°...

## ğŸ¯ ä½¿ç”¨ä¾‹

### åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•
```python
from buttai import process_buttai

# ç”»åƒã‚’åˆ†æ
emotion, label = process_buttai('path/to/image.jpg')

if emotion != 'api error':
    print(f"æ¤œå‡ºç‰©ä½“: {label}")
    print(f"æ„Ÿæƒ…: {emotion}")
else:
    print(f"ã‚¨ãƒ©ãƒ¼: {label}")
```

### çµæœä¾‹
```python
# çŠ¬ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆ
emotion, label = process_buttai('dog_image.jpg')
# emotion = "æ¸©ã‹ã„" (OpenAI APIã‹ã‚‰å–å¾—)
# label = "dog"

# ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
emotion, label = process_buttai('invalid_image.jpg')
# emotion = "api error"
# label = "invalid_image"
```
