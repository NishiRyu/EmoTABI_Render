# buttai.py 物体検出システムの仕組み

## 🎯 概要

`buttai.py`は、YOLOv8を使用して画像内の物体を検出し、検出された物体に基づいてOpenAI APIから感情を取得するシステムです。

## 🏗️ システム構成

```
画像入力 → YOLOv8物体検出 → 最高信頼度物体選択 → OpenAI API → 感情出力
```

## 🔧 主要機能

### 1. YOLOv8モデル管理

#### モデル初期化
```python
def load_model(model_name='yolov8n', conf=0.3):
    """ultralytics YOLOv8 Nanoモデルをロードします"""
    global model, model_conf
    try:
        model_path = f"{model_name}.pt"
        
        # モデルファイルが存在しない場合の処理
        if not os.path.exists(model_path):
            print(f"Model file {model_path} not found. Downloading...")
            model = YOLO(model_name)  # 自動ダウンロード
        else:
            model = YOLO(model_path)
        
        model_conf = conf
        model.overrides['verbose'] = False  # ログを削減
        
        print("YOLO model loaded successfully")
        return True
    except Exception as e:
        print(f"Error loading YOLO model: {e}")
        return False
```

#### 特徴
- **YOLOv8 Nano**: 軽量で高速な物体検出
- **自動ダウンロード**: 初回実行時にモデルを自動取得
- **信頼度設定**: デフォルト0.3、調整可能
- **ログ抑制**: 不要な出力を削減

### 2. 感情取得システム

#### OpenAI API連携
```python
@lru_cache(maxsize=256)
def get_emotion(label):
    """物体ラベルから感情キーワードを取得（API専用版）"""
    try:
        init_openai_client()
        if client is not None:
            prompt = f"物体 '{label}' を見たときの感情を一語で日本語で答えてください。"
            
            # 新API形式 + GPT-3.5-turbo使用
            response = client.chat.completions.create(
                model='gpt-3.5-turbo',
                messages=[{'role':'user','content':prompt}],
                max_tokens=5,  # トークン数削減
                temperature=0.3,  # 温度下げて安定性向上
                timeout=10  # タイムアウト設定
            )
            
            emotion = response.choices[0].message.content.strip().strip('「」"')
            if emotion:
                return emotion
        
        # クライアントが初期化できない場合またはレスポンスが空の場合
        return 'api error'
                
    except Exception as e:
        print(f"OpenAI API error: {e}")
        return 'api error'
```

#### 特徴
- **LRUキャッシュ**: 同じ物体の結果をキャッシュ（最大256件）
- **API優先**: フォールバック辞書を削除、API専用
- **エラーハンドリング**: API失敗時は「api error」を返す
- **コスト最適化**: GPT-3.5-turbo、最大5トークン

### 3. メイン処理フロー

#### 物体検出・感情分析
```python
def process_buttai(image_path):
    """画像パスを受け取り、物体検出と感情ラベルを返す（最適化版）"""
    # モデル初期化
    if model is None:
        if not load_model():
            return 'api error', 'no_model'  # モデル読み込み失敗時

    try:
        # 1) 画像読み込み＆最適化
        img = cv2.imread(image_path)
        if img is None:
            return 'api error', 'invalid_image'
        
        # より効率的なリサイズ（アスペクト比保持）
        h, w = img.shape[:2]
        scale = min(320/w, 320/h)
        new_w, new_h = int(w*scale), int(h*scale)
        img_small = cv2.resize(img, (new_w, new_h), interpolation=cv2.INTER_AREA)

        # 2) YOLOv8 Nano推論（最適化設定）
        results = model(
            img_small, 
            conf=model_conf,
            verbose=False,  # ログ抑制
            save=False,     # 保存しない
            show=False      # 表示しない
        )
        
        r = results[0]
        boxes = r.boxes
        
        if boxes is None or len(boxes) == 0:
            return 'api error', 'no_object'

        # 3) 最も信頼度の高い物体を選択
        confs = boxes.conf.cpu().numpy()
        cls_ids = boxes.cls.cpu().numpy().astype(int)
        
        idx = confs.argmax()
        confidence = confs[idx]
        
        # 信頼度チェック
        if confidence < 0.25:  # 閾値を少し下げて検出率向上
            return 'api error', 'low_confidence'
        
        label = r.names[cls_ids[idx]]
        emotion = get_emotion(label)
        
        return emotion, label
        
    except Exception as e:
        print(f"Object detection error: {e}")
        return 'api error', 'error'
```

## 🔄 処理ステップ

### 1. 画像前処理
1. **画像読み込み**: OpenCV使用
2. **リサイズ**: 320px以下に最適化（アスペクト比保持）
3. **バリデーション**: 画像の有効性確認

### 2. 物体検出
1. **YOLOv8推論**: 最適化された設定で実行
2. **結果取得**: バウンディングボックス、信頼度、クラスID
3. **信頼度フィルタ**: 0.25以上の物体のみ採用

### 3. 感情分析
1. **最高信頼度物体選択**: 最も確実な検出結果を使用
2. **OpenAI API呼び出し**: 物体名から感情を取得
3. **結果返却**: 感情文字列とラベル名

## ⚡ パフォーマンス最適化

### 画像処理最適化
- **リサイズ**: 320px制限でメモリ使用量削減
- **補間方法**: INTER_AREA使用で高品質リサイズ
- **アスペクト比保持**: 歪みなしで処理

### モデル最適化
- **YOLOv8 Nano**: 最軽量モデル選択
- **バッチサイズ**: 単一画像処理
- **ログ抑制**: 不要な出力削除

### API最適化
- **LRUキャッシュ**: 重複呼び出し削減
- **トークン制限**: 最大5トークンで高速化
- **タイムアウト**: 10秒で応答保証

## 🛡️ エラーハンドリング

### エラーケースと対応

| エラーケース | 返り値 | 説明 |
|-------------|--------|------|
| モデル読み込み失敗 | `('api error', 'no_model')` | YOLOv8モデルの初期化に失敗 |
| 画像読み込み失敗 | `('api error', 'invalid_image')` | 画像ファイルが無効または破損 |
| 物体未検出 | `('api error', 'no_object')` | 信頼度の高い物体が見つからない |
| 信頼度不足 | `('api error', 'low_confidence')` | 検出信頼度が0.25未満 |
| API エラー | `('api error', 物体名)` | OpenAI API呼び出しに失敗 |
| その他の例外 | `('api error', 'error')` | 予期しないエラーが発生 |

### 統一エラー形式
- すべてのエラーで「api error」を感情として返す
- フォールバック感情は完全に削除
- エラー詳細は第二戻り値で提供

## 🔧 設定項目

### 環境変数
```bash
OPENAI_API_KEY=your_openai_api_key  # 必須
```

### モデル設定
```python
model_name = 'yolov8n'  # YOLOv8 Nano
conf = 0.3              # 信頼度閾値（デフォルト）
min_conf = 0.25         # 最小信頼度閾値
```

### API設定
```python
model = 'gpt-3.5-turbo'  # OpenAI モデル
max_tokens = 5           # 最大トークン数
temperature = 0.3        # 温度設定
timeout = 10             # タイムアウト（秒）
```

## 📊 検出可能な物体

YOLOv8は80種類の物体を検出可能：

### 人・動物
- person, dog, cat, bird, horse, sheep, cow, elephant, bear, zebra, giraffe

### 乗り物
- car, truck, bus, train, boat, airplane, bicycle, motorcycle

### 家具・電化製品
- chair, table, bed, toilet, tv, laptop, mouse, keyboard, cell phone

### 食べ物
- banana, apple, sandwich, orange, broccoli, carrot, pizza, donut, cake

### スポーツ用品
- frisbee, skis, snowboard, sports ball, kite, baseball bat, tennis racket

### その他多数...

## 🎯 使用例

### 基本的な使用方法
```python
from buttai import process_buttai

# 画像を分析
emotion, label = process_buttai('path/to/image.jpg')

if emotion != 'api error':
    print(f"検出物体: {label}")
    print(f"感情: {emotion}")
else:
    print(f"エラー: {label}")
```

### 結果例
```python
# 犬が検出された場合
emotion, label = process_buttai('dog_image.jpg')
# emotion = "温かい" (OpenAI APIから取得)
# label = "dog"

# エラーの場合
emotion, label = process_buttai('invalid_image.jpg')
# emotion = "api error"
# label = "invalid_image"
```
