# emo_gpt_1.py é›°å›²æ°—æ„Ÿæƒ…åˆ†æã‚·ã‚¹ãƒ†ãƒ ã®ä»•çµ„ã¿

## ğŸ¯ æ¦‚è¦

`emo_gpt_1.py`ã¯ã€OpenAI GPT-4o-mini Vision APIã‚’ä½¿ç”¨ã—ã¦ç”»åƒã®é›°å›²æ°—ã‚„æ„Ÿæƒ…ã‚’ç·åˆçš„ã«åˆ†æã—ã€è‡ªç„¶è¨€èªã§ã®æ„Ÿæƒ…è¡¨ç¾ã¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
ç”»åƒå…¥åŠ› â†’ Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ â†’ OpenAI Vision API â†’ JSONè§£æ â†’ æ„Ÿæƒ…+ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å‡ºåŠ›
```

## ğŸ”§ ä¸»è¦æ©Ÿèƒ½

### 1. OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç®¡ç†

#### é…å»¶åˆæœŸåŒ–
```python
def init_openai_client():
    """OpenAI API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®é…å»¶åˆæœŸåŒ–"""
    global client
    if client is None:
        api_key = os.getenv('OPENAI_API_KEY')
        if api_key:
            try:
                client = OpenAI(api_key=api_key)
            except TypeError as e:
                print(f"OpenAI client initialization error (emo_gpt): {e}")
                client = None
            except Exception as e:
                print(f"OpenAI client initialization error (emo_gpt): {e}")
                client = None
```

#### ç‰¹å¾´
- **é…å»¶åˆæœŸåŒ–**: å¿…è¦æ™‚ã®ã¿ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: åˆæœŸåŒ–å¤±æ•—æ™‚ã®é©åˆ‡ãªå‡¦ç†
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«ç®¡ç†**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§å˜ä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

### 2. Vision API ç”»åƒåˆ†æ

#### ãƒ¡ã‚¤ãƒ³åˆ†æå‡¦ç†
```python
def process_emo_with_api(image_path):
    """OpenAI APIã‚’ä½¿ç”¨ã—ãŸæ„Ÿæƒ…åˆ†æï¼ˆæœ€é©åŒ–ç‰ˆï¼‰"""
    try:
        init_openai_client()
        if client is None:
            return {'emotion_label': 'api error', 'caption': 'API client initialization failed'}
        
        # ç”»åƒã‚’ç›´æ¥åˆ†æï¼ˆVision APIä½¿ç”¨ï¼‰
        with open(image_path, "rb") as image_file:
            import base64
            base64_image = base64.b64encode(image_file.read()).decode('utf-8')
        
        messages = [
            {"role": "system", "content": "ã‚ãªãŸã¯ç”»åƒã®é›°å›²æ°—ã‚’æ„Ÿæƒ…ã§è¡¨ç¾ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯å¿…ãšJSONã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚"},
            {"role": "user", "content": [
                {"type": "text", "text": "ã“ã®ç”»åƒã®é›°å›²æ°—ã‚’è¡¨ã™æ„Ÿæƒ…ã‚’ä¸€ã¤é¸ã‚“ã§ã€ä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„: {\"emotion_label\": \"æ„Ÿæƒ…\", \"caption\": \"èª¬æ˜\"}"},
                {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}}
            ]}
        ]

        # æ–°APIå½¢å¼ + ç”»åƒå¯¾å¿œãƒ¢ãƒ‡ãƒ«
        response = client.chat.completions.create(
            model="gpt-4o-mini",  # ç¾åœ¨åˆ©ç”¨å¯èƒ½ãªç”»åƒåˆ†æå¯¾å¿œãƒ¢ãƒ‡ãƒ«
            messages=messages,
            temperature=0.3,
            max_tokens=150,  # Visionç”¨ã«ãƒˆãƒ¼ã‚¯ãƒ³æ•°å¢—åŠ 
            timeout=15      # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        )

        content = response.choices[0].message.content.strip()
        
        # JSON ãƒ‘ãƒ¼ã‚¹å‡¦ç†...
        
    except Exception as e:
        print(f"OpenAI API error: {e}")
        return {'emotion_label': 'api error', 'caption': f'API error: {str(e)}'}
```

#### APIè¨­å®šæœ€é©åŒ–
- **ãƒ¢ãƒ‡ãƒ«**: GPT-4o-miniï¼ˆVisionå¯¾å¿œã€ã‚³ã‚¹ãƒˆåŠ¹ç‡é‡è¦–ï¼‰
- **Temperature**: 0.3ï¼ˆå®‰å®šã—ãŸçµæœï¼‰
- **max_tokens**: 150ï¼ˆVisionç”¨ã«å¢—åŠ ï¼‰
- **timeout**: 15ç§’ï¼ˆç”»åƒå‡¦ç†ç”¨ã«å»¶é•·ï¼‰

### 3. JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†

#### å …ç‰¢ãª JSON è§£æ
```python
# JSON ãƒ‘ãƒ¼ã‚¹
try:
    data = json.loads(content)
    # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if 'emotion_label' not in data or not data['emotion_label']:
        return {'emotion_label': 'api error', 'caption': 'Invalid API response format'}
    return data
    
except json.JSONDecodeError:
    # ç´”ç²‹ãª JSON éƒ¨åˆ†ã ã‘ã‚’æŠ½å‡º
    match = re.search(r'\{[^}]*"emotion_label"[^}]*\}', content)
    if match:
        try:
            data = json.loads(match.group())
            return data
        except json.JSONDecodeError:
            pass
    
    # JSONæŠ½å‡ºå¤±æ•—æ™‚ã®å‡¦ç†
    return {'emotion_label': 'api error', 'caption': f'JSON parsing failed: {content[:100]}...'}
```

#### å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—
1. **ç›´æ¥JSONè§£æ**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãã®ã¾ã¾JSONåŒ–
2. **æ­£è¦è¡¨ç¾æŠ½å‡º**: JSONéƒ¨åˆ†ã®ã¿ã‚’æŠ½å‡ºã—ã¦å†è§£æ
3. **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: è§£æå¤±æ•—æ™‚ã¯ã€Œapi errorã€ã‚’è¿”ã™

### 4. ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

#### çµ±åˆå‡¦ç†é–¢æ•°
```python
def process_emo(image_path):
    """ç”»åƒãƒ‘ã‚¹ã‚’å—ã‘å–ã‚Šã€æ„Ÿæƒ…åˆ†æã‚’è¡Œã†ï¼ˆAPIã‚¨ãƒ©ãƒ¼ç‰ˆï¼‰"""
    
    # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    if not os.path.exists(image_path):
        return {'emotion_label': 'api error', 'caption': f'Image file not found: {image_path}'}
    
    # OpenAI APIã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯
    api_key = os.getenv('OPENAI_API_KEY')
    if not api_key or not api_key.strip():
        return {'emotion_label': 'api error', 'caption': 'OpenAI API key is not configured'}
    
    # OpenAI APIå®Ÿè¡Œ
    try:
        result = process_emo_with_api(image_path)
        if result and result.get('emotion_label') != 'api error':
            return result
        else:
            return {'emotion_label': 'api error', 'caption': 'OpenAI API returned empty or error result'}
    except Exception as e:
        print(f"OpenAI API processing failed: {e}")
        return {'emotion_label': 'api error', 'caption': f'Emotion analysis failed: {str(e)}'}
```

## ğŸ”„ å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—

### 1. äº‹å‰ãƒã‚§ãƒƒã‚¯
1. **ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª**: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®æœ‰åŠ¹æ€§ç¢ºèª
2. **APIã‚­ãƒ¼ç¢ºèª**: ç’°å¢ƒå¤‰æ•°ã‹ã‚‰APIã‚­ãƒ¼å–å¾—
3. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–**: OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æº–å‚™

### 2. ç”»åƒã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
1. **ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿**: ãƒã‚¤ãƒŠãƒªãƒ¢ãƒ¼ãƒ‰ã§ç”»åƒèª­ã¿è¾¼ã¿
2. **Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰**: Vision APIç”¨ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
3. **ãƒ‡ãƒ¼ã‚¿URIä½œæˆ**: `data:image/jpeg;base64,`å½¢å¼

### 3. APIå‘¼ã³å‡ºã—
1. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹ç¯‰**: ã‚·ã‚¹ãƒ†ãƒ ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š
2. **Vision APIå®Ÿè¡Œ**: GPT-4o-miniã§ç”»åƒåˆ†æ
3. **ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—**: JSONå½¢å¼ã®çµæœå—ä¿¡

### 4. çµæœå‡¦ç†
1. **JSONè§£æ**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
2. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: å¿…è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèª
3. **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: å¤±æ•—æ™‚ã®çµ±ä¸€ã‚¨ãƒ©ãƒ¼å½¢å¼è¿”å´

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### å‡¦ç†æ™‚é–“
- **å°ã•ã„ç”»åƒ** (< 1MB): 2-3ç§’
- **ä¸­ç¨‹åº¦ç”»åƒ** (1-5MB): 3-5ç§’
- **å¤§ãã„ç”»åƒ** (> 5MB): 5-8ç§’

### åˆ¶é™äº‹é …
- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: OpenAI APIã®åˆ¶é™ã«ä¾å­˜
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: APIã‚­ãƒ¼ã®ãƒ—ãƒ©ãƒ³ã«ä¾å­˜
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 15ç§’ã§å‡¦ç†ä¸­æ–­

## ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã¨å¯¾å¿œ

| ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ | è¿”ã‚Šå€¤ | èª¬æ˜ |
|-------------|--------|------|
| ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨ | `{'emotion_label': 'api error', 'caption': 'Image file not found: ...'}` | æŒ‡å®šãƒ‘ã‚¹ã«ç”»åƒãŒå­˜åœ¨ã—ãªã„ |
| APIã‚­ãƒ¼æœªè¨­å®š | `{'emotion_label': 'api error', 'caption': 'OpenAI API key is not configured'}` | ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ |
| ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–å¤±æ•— | `{'emotion_label': 'api error', 'caption': 'API client initialization failed'}` | OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•— |
| APIå‘¼ã³å‡ºã—å¤±æ•— | `{'emotion_label': 'api error', 'caption': 'API error: ...'}` | OpenAI APIã‹ã‚‰ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ |
| JSONè§£æå¤±æ•— | `{'emotion_label': 'api error', 'caption': 'JSON parsing failed: ...'}` | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®JSONåŒ–ã«å¤±æ•— |
| ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚¨ãƒ©ãƒ¼ | `{'emotion_label': 'api error', 'caption': 'Invalid API response format'}` | å¿…è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ |

### çµ±ä¸€ã‚¨ãƒ©ãƒ¼å½¢å¼
- ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã§`emotion_label: 'api error'`
- è©³ç´°æƒ…å ±ã¯`caption`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ ¼ç´
- ä¾‹å¤–ã‚’æŠ•ã’ãšã«è¾æ›¸å½¢å¼ã§è¿”å´

## ğŸ”§ è¨­å®šé …ç›®

### ç’°å¢ƒå¤‰æ•°
```bash
OPENAI_API_KEY=your_openai_api_key  # å¿…é ˆ
```

### APIè¨­å®š
```python
model = "gpt-4o-mini"    # Visionå¯¾å¿œãƒ¢ãƒ‡ãƒ«
temperature = 0.3        # å‡ºåŠ›ã®ä¸€è²«æ€§é‡è¦–
max_tokens = 150         # Visionç”¨ã«å¢—åŠ 
timeout = 15             # ç”»åƒå‡¦ç†ç”¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
```

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š
```python
system_prompt = "ã‚ãªãŸã¯ç”»åƒã®é›°å›²æ°—ã‚’æ„Ÿæƒ…ã§è¡¨ç¾ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯å¿…ãšJSONã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚"

user_prompt = "ã“ã®ç”»åƒã®é›°å›²æ°—ã‚’è¡¨ã™æ„Ÿæƒ…ã‚’ä¸€ã¤é¸ã‚“ã§ã€ä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„: {\"emotion_label\": \"æ„Ÿæƒ…\", \"caption\": \"èª¬æ˜\"}"
```

## ğŸ“Š ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

### æ­£å¸¸æ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```json
{
    "emotion_label": "ç©ã‚„ã‹",
    "caption": "é’ç©ºã¨ç·‘ã®é¢¨æ™¯ãŒå¿ƒã‚’è½ã¡ç€ã‹ã›ã‚‹é›°å›²æ°—ã‚’é†¸ã—å‡ºã—ã¦ã„ã¾ã™"
}
```

### ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```json
{
    "emotion_label": "api error",
    "caption": "API error: Rate limit exceeded"
}
```

## ğŸ¯ ä½¿ç”¨ä¾‹

### åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•
```python
from emo_gpt_1 import process_emo

# ç”»åƒã‚’åˆ†æ
result = process_emo('path/to/image.jpg')

if result['emotion_label'] != 'api error':
    print(f"æ„Ÿæƒ…: {result['emotion_label']}")
    print(f"èª¬æ˜: {result['caption']}")
else:
    print(f"ã‚¨ãƒ©ãƒ¼: {result['caption']}")
```

### çµæœä¾‹
```python
# æ­£å¸¸å‡¦ç†ã®å ´åˆ
result = process_emo('sunset.jpg')
# {
#     'emotion_label': 'æš–ã‹ã„',
#     'caption': 'å¤•æ—¥ã®æ¸©ã‹ã„å…‰ãŒå¿ƒåœ°ã‚ˆã„æ„Ÿæƒ…ã‚’å‘¼ã³èµ·ã“ã—ã¾ã™'
# }

# ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
result = process_emo('nonexistent.jpg')
# {
#     'emotion_label': 'api error',
#     'caption': 'Image file not found: nonexistent.jpg'
# }
```

## ğŸš€ æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ

### ã‚³ã‚¹ãƒˆæœ€é©åŒ–
- **GPT-4o-miniä½¿ç”¨**: GPT-4ã‚ˆã‚Šå¤§å¹…ã«ã‚³ã‚¹ãƒˆå‰Šæ¸›
- **ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™**: max_tokens=150ã§ä¸è¦ãªå‡ºåŠ›ã‚’æŠ‘åˆ¶
- **Temperatureèª¿æ•´**: 0.3ã§å®‰å®šã—ãŸçµæœã‚’ç¢ºä¿

### ç²¾åº¦å‘ä¸Š
- **æ˜ç¢ºãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: JSONå½¢å¼ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
- **ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: å½¹å‰²ã‚’æ˜ç¢ºã«å®šç¾©
- **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®å³å¯†ãƒã‚§ãƒƒã‚¯

### ä¿¡é ¼æ€§å‘ä¸Š
- **è¤‡æ•°æ®µéšã®è§£æ**: ç›´æ¥è§£æâ†’æ­£è¦è¡¨ç¾æŠ½å‡ºâ†’ã‚¨ãƒ©ãƒ¼å‡¦ç†
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š**: é•·æ™‚é–“ã®å¿œç­”å¾…ã¡ã‚’é˜²æ­¢
- **çµ±ä¸€ã‚¨ãƒ©ãƒ¼å½¢å¼**: ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
