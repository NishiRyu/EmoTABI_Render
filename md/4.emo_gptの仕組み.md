# emo_gpt_1.py 雰囲気感情分析システムの仕組み

## 🎯 概要

`emo_gpt_1.py`は、OpenAI GPT-4o-mini Vision APIを使用して画像の雰囲気や感情を総合的に分析し、自然言語での感情表現とキャプションを生成するシステムです。

## 🏗️ システム構成

```
画像入力 → Base64エンコード → OpenAI Vision API → JSON解析 → 感情+キャプション出力
```

## 🔧 主要機能

### 1. OpenAI クライアント管理

#### 遅延初期化
```python
def init_openai_client():
    """OpenAI API クライアントの遅延初期化"""
    global client
    if client is None:
        api_key = os.getenv('OPENAI_API_KEY')
        if api_key:
            try:
                client = OpenAI(api_key=api_key)
            except TypeError as e:
                print(f"OpenAI client initialization error (emo_gpt): {e}")
                client = None
            except Exception as e:
                print(f"OpenAI client initialization error (emo_gpt): {e}")
                client = None
```

#### 特徴
- **遅延初期化**: 必要時のみクライアント作成
- **エラーハンドリング**: 初期化失敗時の適切な処理
- **グローバル管理**: アプリケーション全体で単一インスタンス

### 2. Vision API 画像分析

#### メイン分析処理
```python
def process_emo_with_api(image_path):
    """OpenAI APIを使用した感情分析（最適化版）"""
    try:
        init_openai_client()
        if client is None:
            return {'emotion_label': 'api error', 'caption': 'API client initialization failed'}
        
        # 画像を直接分析（Vision API使用）
        with open(image_path, "rb") as image_file:
            import base64
            base64_image = base64.b64encode(image_file.read()).decode('utf-8')
        
        messages = [
            {"role": "system", "content": "あなたは画像の雰囲気を感情で表現するシステムです。レスポンスは必ずJSONのみを返してください。"},
            {"role": "user", "content": [
                {"type": "text", "text": "この画像の雰囲気を表す感情を一つ選んで、以下の形式で回答してください: {\"emotion_label\": \"感情\", \"caption\": \"説明\"}"},
                {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}}
            ]}
        ]

        # 新API形式 + 画像対応モデル
        response = client.chat.completions.create(
            model="gpt-4o-mini",  # 現在利用可能な画像分析対応モデル
            messages=messages,
            temperature=0.3,
            max_tokens=150,  # Vision用にトークン数増加
            timeout=15      # タイムアウト設定
        )

        content = response.choices[0].message.content.strip()
        
        # JSON パース処理...
        
    except Exception as e:
        print(f"OpenAI API error: {e}")
        return {'emotion_label': 'api error', 'caption': f'API error: {str(e)}'}
```

#### API設定最適化
- **モデル**: GPT-4o-mini（Vision対応、コスト効率重視）
- **Temperature**: 0.3（安定した結果）
- **max_tokens**: 150（Vision用に増加）
- **timeout**: 15秒（画像処理用に延長）

### 3. JSON レスポンス処理

#### 堅牢な JSON 解析
```python
# JSON パース
try:
    data = json.loads(content)
    # バリデーション
    if 'emotion_label' not in data or not data['emotion_label']:
        return {'emotion_label': 'api error', 'caption': 'Invalid API response format'}
    return data
    
except json.JSONDecodeError:
    # 純粋な JSON 部分だけを抽出
    match = re.search(r'\{[^}]*"emotion_label"[^}]*\}', content)
    if match:
        try:
            data = json.loads(match.group())
            return data
        except json.JSONDecodeError:
            pass
    
    # JSON抽出失敗時の処理
    return {'emotion_label': 'api error', 'caption': f'JSON parsing failed: {content[:100]}...'}
```

#### 処理ステップ
1. **直接JSON解析**: レスポンスをそのままJSON化
2. **正規表現抽出**: JSON部分のみを抽出して再解析
3. **エラー処理**: 解析失敗時は「api error」を返す

### 4. メイン処理インターフェース

#### 統合処理関数
```python
def process_emo(image_path):
    """画像パスを受け取り、感情分析を行う（APIエラー版）"""
    
    # 画像ファイル存在チェック
    if not os.path.exists(image_path):
        return {'emotion_label': 'api error', 'caption': f'Image file not found: {image_path}'}
    
    # OpenAI APIキーチェック
    api_key = os.getenv('OPENAI_API_KEY')
    if not api_key or not api_key.strip():
        return {'emotion_label': 'api error', 'caption': 'OpenAI API key is not configured'}
    
    # OpenAI API実行
    try:
        result = process_emo_with_api(image_path)
        if result and result.get('emotion_label') != 'api error':
            return result
        else:
            return {'emotion_label': 'api error', 'caption': 'OpenAI API returned empty or error result'}
    except Exception as e:
        print(f"OpenAI API processing failed: {e}")
        return {'emotion_label': 'api error', 'caption': f'Emotion analysis failed: {str(e)}'}
```

## 🔄 処理ステップ

### 1. 事前チェック
1. **ファイル存在確認**: 画像ファイルの有効性確認
2. **APIキー確認**: 環境変数からAPIキー取得
3. **クライアント初期化**: OpenAIクライアントの準備

### 2. 画像エンコード
1. **ファイル読み込み**: バイナリモードで画像読み込み
2. **Base64エンコード**: Vision API用にエンコード
3. **データURI作成**: `data:image/jpeg;base64,`形式

### 3. API呼び出し
1. **メッセージ構築**: システム・ユーザープロンプト設定
2. **Vision API実行**: GPT-4o-miniで画像分析
3. **レスポンス取得**: JSON形式の結果受信

### 4. 結果処理
1. **JSON解析**: レスポンスをパース
2. **バリデーション**: 必要フィールドの存在確認
3. **エラー処理**: 失敗時の統一エラー形式返却

## ⚡ パフォーマンス特性

### 処理時間
- **小さい画像** (< 1MB): 2-3秒
- **中程度画像** (1-5MB): 3-5秒
- **大きい画像** (> 5MB): 5-8秒

### 制限事項
- **ファイルサイズ**: OpenAI APIの制限に依存
- **レート制限**: APIキーのプランに依存
- **タイムアウト**: 15秒で処理中断

## 🛡️ エラーハンドリング

### エラーケースと対応

| エラーケース | 返り値 | 説明 |
|-------------|--------|------|
| 画像ファイル不存在 | `{'emotion_label': 'api error', 'caption': 'Image file not found: ...'}` | 指定パスに画像が存在しない |
| APIキー未設定 | `{'emotion_label': 'api error', 'caption': 'OpenAI API key is not configured'}` | 環境変数が設定されていない |
| クライアント初期化失敗 | `{'emotion_label': 'api error', 'caption': 'API client initialization failed'}` | OpenAIクライアントの作成に失敗 |
| API呼び出し失敗 | `{'emotion_label': 'api error', 'caption': 'API error: ...'}` | OpenAI APIからエラーレスポンス |
| JSON解析失敗 | `{'emotion_label': 'api error', 'caption': 'JSON parsing failed: ...'}` | レスポンスのJSON化に失敗 |
| レスポンス形式エラー | `{'emotion_label': 'api error', 'caption': 'Invalid API response format'}` | 必要フィールドが不足 |

### 統一エラー形式
- すべてのエラーで`emotion_label: 'api error'`
- 詳細情報は`caption`フィールドに格納
- 例外を投げずに辞書形式で返却

## 🔧 設定項目

### 環境変数
```bash
OPENAI_API_KEY=your_openai_api_key  # 必須
```

### API設定
```python
model = "gpt-4o-mini"    # Vision対応モデル
temperature = 0.3        # 出力の一貫性重視
max_tokens = 150         # Vision用に増加
timeout = 15             # 画像処理用タイムアウト
```

### プロンプト設定
```python
system_prompt = "あなたは画像の雰囲気を感情で表現するシステムです。レスポンスは必ずJSONのみを返してください。"

user_prompt = "この画像の雰囲気を表す感情を一つ選んで、以下の形式で回答してください: {\"emotion_label\": \"感情\", \"caption\": \"説明\"}"
```

## 📊 レスポンス形式

### 正常時のレスポンス
```json
{
    "emotion_label": "穏やか",
    "caption": "青空と緑の風景が心を落ち着かせる雰囲気を醸し出しています"
}
```

### エラー時のレスポンス
```json
{
    "emotion_label": "api error",
    "caption": "API error: Rate limit exceeded"
}
```

## 🎯 使用例

### 基本的な使用方法
```python
from emo_gpt_1 import process_emo

# 画像を分析
result = process_emo('path/to/image.jpg')

if result['emotion_label'] != 'api error':
    print(f"感情: {result['emotion_label']}")
    print(f"説明: {result['caption']}")
else:
    print(f"エラー: {result['caption']}")
```

### 結果例
```python
# 正常処理の場合
result = process_emo('sunset.jpg')
# {
#     'emotion_label': '暖かい',
#     'caption': '夕日の温かい光が心地よい感情を呼び起こします'
# }

# エラーの場合
result = process_emo('nonexistent.jpg')
# {
#     'emotion_label': 'api error',
#     'caption': 'Image file not found: nonexistent.jpg'
# }
```

## 🚀 最適化のポイント

### コスト最適化
- **GPT-4o-mini使用**: GPT-4より大幅にコスト削減
- **トークン制限**: max_tokens=150で不要な出力を抑制
- **Temperature調整**: 0.3で安定した結果を確保

### 精度向上
- **明確なプロンプト**: JSON形式を明示的に指定
- **システムメッセージ**: 役割を明確に定義
- **バリデーション**: レスポンス形式の厳密チェック

### 信頼性向上
- **複数段階の解析**: 直接解析→正規表現抽出→エラー処理
- **タイムアウト設定**: 長時間の応答待ちを防止
- **統一エラー形式**: 一貫したエラーハンドリング
