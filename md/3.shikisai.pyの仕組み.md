# shikisai.py 色彩感情分析システムの仕組み

## 🎯 概要

`shikisai.py`は、画像の色彩情報を分析し、K-meansクラスタリングと感情マッピングCSVを使用して画像の感情を判定するシステムです。

## 🏗️ システム構成

```
画像入力 → 色抽出(K-means) → 感情マッピング(CSV) → 最頻感情選択 → 感情出力
```

## 🔧 主要機能

### 1. 感情マッピングデータ管理

#### CSV読み込み
```python
def load_emotion_mapping(path=CSV_PATH):
    """感情マッピングデータの読み込み（フォールバック機能付き）"""
    global _emotion_mapping_cache
    if _emotion_mapping_cache is None:
        # 複数のパスを試行
        possible_paths = [
            path,  # デフォルトパス
            '/app/output_emo.csv',  # Docker作業ディレクトリ
            os.path.join(os.getcwd(), 'output_emo.csv'),  # カレントディレクトリ
            'output_emo.csv'  # 相対パス
        ]
        
        for csv_path in possible_paths:
            try:
                _emotion_mapping_cache = pd.read_csv(csv_path)
                print(f"Emotion mapping loaded from {csv_path}")
                return _emotion_mapping_cache
            except FileNotFoundError:
                print(f"CSV file {csv_path} not found. Trying next path...")
                continue
            except Exception as e:
                print(f"Error loading {csv_path}: {e}")
                continue
                
        # すべてのパスで失敗した場合はエラーで停止
        error_msg = f"CSV file 'output_emo.csv' not found in any location. Tried paths: {possible_paths}"
        print(f"CRITICAL ERROR: {error_msg}")
        raise FileNotFoundError(error_msg)
    
    return _emotion_mapping_cache
```

#### 特徴
- **グローバルキャッシュ**: 一度読み込んだデータを再利用
- **マルチパス対応**: 複数の場所からCSVファイルを探索
- **Docker対応**: コンテナ環境での動作を考慮

### 2. 色彩抽出システム

#### K-meansクラスタリング
```python
def extract_colors(image, num_colors=5, sample_size=2000):
    """色抽出（メモリ効率改善版）"""
    # 1) 低解像度リサイズ（メモリ効率向上）
    img = cv2.resize(image, (150, 100), interpolation=cv2.INTER_AREA)
    pixels = img.reshape(-1, 3)

    # 2) ピクセル数が多い場合はランダムサンプリング
    if pixels.shape[0] > sample_size:
        idx = np.random.choice(pixels.shape[0], sample_size, replace=False)
        pixels = pixels[idx]

    # 3) MiniBatchKMeans による高速クラスタリング（最適化）
    km = MiniBatchKMeans(
        n_clusters=num_colors,
        random_state=42,
        batch_size=min(sample_size, 100),  # バッチサイズ最適化
        max_iter=10,  # イテレーション数制限
        n_init=1      # 初期化回数削減
    )
    labels = km.fit_predict(pixels)

    counts = np.bincount(labels)
    centers = km.cluster_centers_
    order = counts.argsort()[::-1]
    return counts[order], centers[order]
```

#### 最適化ポイント
- **画像リサイズ**: 150x100に縮小してメモリ効率化
- **ランダムサンプリング**: 2000ピクセル以上の場合にサンプリング
- **MiniBatchKMeans**: 通常のK-meansより高速
- **パラメータ調整**: イテレーション数と初期化回数を制限

### 3. 感情マッピングシステム

#### 色距離計算とキャッシュ
```python
@lru_cache(maxsize=64)
def cached_color_distance(r, g, b, df_hash):
    """色距離計算のキャッシュ機能"""
    df = load_emotion_mapping()
    color = np.array([r, g, b])
    dists = np.linalg.norm(df[['R', 'G', 'B']].values - color, axis=1)
    idx = np.argmin(dists)
    
    # emotion1列以降の感情データを取得
    emotion_cols = [col for col in df.columns if col.startswith('emotion')]
    if emotion_cols:
        emotions = df.iloc[idx][emotion_cols].dropna().tolist()
        return emotions
    else:
        # emotion1列がない場合はエラー
        return ['api error']
```

#### 特徴
- **LRUキャッシュ**: 同じ色の計算結果をキャッシュ（最大64件）
- **ユークリッド距離**: RGB空間での最近傍色を検索
- **エラーハンドリング**: CSVフォーマット異常時は「api error」

### 4. 円グラフ生成（オプション）

#### matplotlib使用
```python
def create_color_pie_chart(counts, centers, image_path):
    """円グラフ作成（エラーハンドリング強化版）"""
    try:
        # matplotlibの遅延インポート＆設定
        import matplotlib
        matplotlib.use('Agg')  # GUIバックエンドを使用しない
        from matplotlib import pyplot as plt

        colors = [f"#{int(c[0]):02x}{int(c[1]):02x}{int(c[2]):02x}" for c in centers]
        base = os.path.splitext(os.path.basename(image_path))[0]
        out_dir = os.path.join('static', 'charts')
        os.makedirs(out_dir, exist_ok=True)
        chart_file = f"{base}_pie_chart.png"
        path = os.path.join(out_dir, chart_file)

        # 最適化されたプロット設定
        plt.figure(figsize=(4, 4), dpi=80)  # DPI下げてファイルサイズ削減
        plt.pie(counts, colors=colors, startangle=90)
        plt.axis('equal')
        plt.tight_layout()
        plt.savefig(path, bbox_inches='tight', dpi=80)  # 保存時もDPI指定
        plt.close()
        plt.clf()  # メモリクリア
        
        return chart_file
        
    except ImportError:
        print("Matplotlib not available. Skipping chart creation.")
        return ''
    except Exception as e:
        print(f"Error creating pie chart: {e}")
        return ''
```

## 🔄 処理ステップ

### 1. 画像前処理
1. **画像読み込み**: OpenCV使用
2. **RGB変換**: BGR→RGB変換
3. **バリデーション**: 画像の有効性確認

### 2. 色彩抽出
1. **リサイズ**: 150x100に縮小
2. **ピクセル配列化**: 3次元→2次元変換
3. **サンプリング**: 必要に応じてランダムサンプリング
4. **K-meansクラスタリング**: 主要色を5色抽出

### 3. 感情マッピング
1. **色距離計算**: 各抽出色とCSV内の色との距離計算
2. **最近傍検索**: 最も近い色の感情を取得
3. **感情収集**: 全ての抽出色から感情を収集

### 4. 結果統合
1. **頻度計算**: Counter使用で最頻感情を計算
2. **円グラフ生成**: オプションで色分布を可視化
3. **結果返却**: 感情とグラフファイル名

## ⚡ パフォーマンス最適化

### メモリ効率化
- **画像リサイズ**: 150x100で処理負荷削減
- **ピクセルサンプリング**: 大きな画像でのメモリ使用量制限
- **キャッシュ活用**: 同じ色の再計算を回避

### 処理速度向上
- **MiniBatchKMeans**: 通常のK-meansより高速
- **パラメータ調整**: イテレーション数を10に制限
- **並列処理対応**: ThreadPoolExecutorと組み合わせ可能

### グラフ最適化
- **DPI設定**: 80に設定してファイルサイズ削減
- **メモリクリア**: plt.close()とplt.clf()で確実にクリア
- **遅延インポート**: matplotlib使用時のみインポート

## 🛡️ エラーハンドリング

### エラーケースと対応

| エラーケース | 返り値 | 説明 |
|-------------|--------|------|
| 画像読み込み失敗 | `('api error', '')` | 画像ファイルが無効または破損 |
| CSV読み込み失敗 | `FileNotFoundError` | 感情マッピングCSVが見つからない |
| 色抽出失敗 | `('api error', '')` | K-meansクラスタリングに失敗 |
| 感情未取得 | `('api error', '')` | 感情データが空の場合 |
| その他の例外 | `('api error', '')` | 予期しないエラーが発生 |

### 統一エラー形式
- すべてのエラーで「api error」を感情として返す
- フォールバック感情「穏やか」を削除
- エラー詳細はログに出力

## 📊 感情マッピングCSV形式

### CSVファイル構造
```csv
R,G,B,word1,word2,word3,word4,word5,word6,word7,word8,word9,word10,...
184,10,82,明るい,陽気な,深い,重い,にごった,派手な,きれいな,かたい,荒々しい,...
125,27,67,暗い,陰気な,深い,重い,にごった,地味な,きたない,かたい,荒々しい,...
245,124,131,明るい,陽気な,浅い,軽い,澄んだ,派手な,きれいな,やわらかい,...
```

### データ特徴
- **RGB値**: 0-255の色情報
- **感情語**: 重複除去済みの感情キーワード
- **行数**: 約66色の感情マッピング
- **列数**: 最大30の感情語

## 🔧 設定項目

### 色抽出設定
```python
num_colors = 5        # 抽出する主要色数
sample_size = 2000    # サンプリングサイズ
resize_width = 150    # リサイズ幅
resize_height = 100   # リサイズ高さ
```

### K-means設定
```python
batch_size = 100      # MiniBatchKMeansバッチサイズ
max_iter = 10         # 最大イテレーション数
n_init = 1           # 初期化回数
random_state = 42    # 乱数シード
```

### キャッシュ設定
```python
maxsize = 64         # LRUキャッシュサイズ
```

## 🎯 使用例

### 基本的な使用方法
```python
from shikisai import get_color_emotions

# 画像を分析
emotion, chart_file = get_color_emotions('path/to/image.jpg')

if emotion != 'api error':
    print(f"主要感情: {emotion}")
    if chart_file:
        print(f"色分布グラフ: {chart_file}")
else:
    print("エラーが発生しました")
```

### 結果例
```python
# 正常処理の場合
emotion, chart = get_color_emotions('sunset.jpg')
# emotion = "暖かい"
# chart = "sunset_pie_chart.png"

# エラーの場合
emotion, chart = get_color_emotions('invalid.jpg')
# emotion = "api error"
# chart = ""
```

## 📈 処理時間

### 典型的な処理時間
- **小さい画像** (< 500KB): 0.3-0.5秒
- **中程度画像** (500KB-2MB): 0.5-1.0秒
- **大きい画像** (> 2MB): 1.0-2.0秒

### ボトルネック
1. **K-meansクラスタリング**: 全体の60-70%
2. **色距離計算**: 全体の20-30%
3. **画像読み込み・前処理**: 全体の10-20%
